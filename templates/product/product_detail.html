{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="section-content padding-y bg">
  <div class="container">
    <!-- ============================ PRODUCT DETAILS ================================= -->
    <div class="card">
      <div class="row no-gutters">
        <aside class="col-md-6">
          <article class="gallery-wrap">
            <div class="img-big-wrap text-center">
              <a href="#"><img src="{{ single_product.images }}" alt="Product Image" class="img-fluid rounded" /></a>
            </div>
          </article>
        </aside>

        <main class="col-md-6 border-left">
          <article class="content-body">
            <h2 class="title text-primary">{{ single_product.product_name }}</h2>
            <div class="mb-3">
              <var class="price h4 text-danger">{{ single_product.price }}</var>
            </div>

            {% if single_product.description %}
              <p class="text-muted">{{ single_product.description }}</p>
            {% else %}
              <p class="text-muted">Sản phẩm chưa có mô tả</p>
            {% endif %}

            <hr />

            {% if in_cart %}
              <div class="d-flex gap-2">
                <a href="#" class="btn btn-success disabled">
                  <span class="text">Đã thêm vào giỏ hàng</span>
                  <i class="fas fa-shopping-cart"></i>
                </a>
                <a href="{% url 'cart' %}" class="btn btn-primary">
                  <span class="text">Đến giỏ hàng</span>
                  <i class="fas fa-shopping-cart"></i>
                </a>
              </div>
            {% elif single_product.stock > 0 %}
              <a href="{% url 'add_cart' single_product.id %}" class="btn btn-primary">
                <span class="text">Thêm vào giỏ hàng</span>
                <i class="fas fa-shopping-cart"></i>
              </a>
            {% else %}
              <h3 class="text-danger">Đã hết hàng</h3>
            {% endif %}
          </article>
        </main>
      </div>
    </div>

    <!-- ============================ REVIEWS SECTION ================================= -->
    <div class="mt-5">
		<h3 class="text-primary">Đánh giá sản phẩm</h3>
		<div id="review-summary" class="bg-light p-3 rounded">
		  <p class="mb-1">
			<strong>Trung bình sao:</strong> <span class="text-warning">{{ average_rating|floatformat:1 }} / 5</span>
		  </p>
		  <p><strong>Tổng đánh giá:</strong> {{ review_count }}</p>
		</div>
	  
		<div id="reviews" class="mt-4">
		  {% comment %} {% for review in reviews %}
		  <div class="review-item mb-4 p-3 border rounded">
			<p><strong>{{ review.user.full_name }}</strong> - <span class="text-warning">{{ review.rating }} &#9733;</span></p>
			<p>{{ review.review }}</p>
	  
			<div class="mt-2">
			  <button class="btn btn-outline-primary btn-sm">Thích ({{ review.likes.count }})</button>
			  <button class="btn btn-outline-secondary btn-sm">Không thích ({{ review.dislikes.count }})</button>
			  <button class="btn btn-outline-success btn-sm">Trả lời</button>
			</div>
	  
			{% for reply in review.replies.all %}
			<div class="ml-4 mt-3 p-2 bg-light border rounded">
			  <p><strong>{{ reply.user.full_name }}</strong>: {{ reply.review }}</p>
			</div>
			{% endfor %}
		  </div>
		  {% endfor %} {% endcomment %}
		</div>
		{% if review_count == 0 %}
		<p class="text-muted">Hãy là người đầu tiên đánh giá sản phẩm!</p>
		{% endif %}
	  </div>

      <!-- ============================ ADD REVIEW FORM ================================= -->
      <h3 class="mt-5">Thêm đánh giá</h3>
      {% if user.is_authenticated %}
      <form id="review-form" action="" method="POST" enctype="multipart/form-data" class="p-4 bg-light rounded">        
        {% csrf_token %}
        <label for="rating">Chọn mức sao:</label>
        <div class="rating mb-3">
          {% for star in "12345" %}
          <input type="radio" name="rating" id="star{{ star }}" value="{{ star }}" required />
          <label for="star{{ star }}" class="star">&#9733;</label>
          {% endfor %}
        </div>
        
        <label for="review">Viết nhận xét:</label>

        <div class="form-group mb-3">
          <label for="media" class="sr-only">Tải lên hình ảnh hoặc video:</label>
          <input type="file" name="media" id="media" class="form-control-file" style="display: none;" />
          <label for="media" class="btn btn-outline-secondary"><i class="fas fa-upload"></i></label>
        </div>

        <textarea name="review" id="review" class="form-control mb-3" placeholder="Nhận xét của bạn..." required></textarea>

        <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
      </form>
      {% else %}
      <p>Vui lòng <a href="{% url 'login' %}">đăng nhập</a> để thêm đánh giá.</p>
      {% endif %}
    </div>
  </div>
</section>

<style>
  .rating {
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
  }

  .star {
    font-size: 2rem;
    color: #ddd;
    cursor: pointer;
    margin: 0 0.1rem;
  }

  .star:hover,
  .star:hover ~ .star,
  input[type="radio"]:checked ~ .star {
    color: #ffc107;
  }

  input[type="radio"] {
    display: none;
  }

  .review-item {
    background-color: #f8f9fa;
  }

  .btn-outline-primary {
    transition: all 0.3s ease;
  }

  .btn-outline-primary:hover {
    background-color: #007bff;
    color: #fff;
  }
</style>
{% endblock %}
